<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>E Shop - Bootstrap Ecommerce Template</title>
        <meta content="width=device-width, initial-scale=1.0" name="viewport">
        <meta content="Bootstrap Ecommerce Template" name="keywords">
        <meta content="Bootstrap Ecommerce Template Free Download" name="description">

        <!-- Favicon -->
        <link href="img/favicon.ico" rel="icon">

        <!-- Google Fonts -->
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,700&display=swap" rel="stylesheet">

        <!-- CSS Libraries -->
        <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
        <link href="lib/slick/slick.css" rel="stylesheet">
        <link href="lib/slick/slick-theme.css" rel="stylesheet">

        <!-- Template Stylesheet -->
        <link href="css/style.css" rel="stylesheet">
        <script src="https://www.paypal.com/sdk/js?client-id=AcrhO-S82bpcgFwD7QLBuXnCkiYhTT--F7Q1MthgcJos4FlsnFTaGrik3D4_-GIVfk2pNIsIrfZQ3yxU&currency=USD"></script>

<style>

.lds-roller,
.lds-roller div,
.lds-roller div:after {
  box-sizing: border-box;
}

.lds-roller {
  display: none; /* Initially hidden */
    position: fixed; /* Fixed position relative to the viewport */
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%); /* Center horizontally and vertically */
    background-color: rgba(255, 255, 255, 0.8); /* Optional: semi-transparent background */
    z-index: 9999; /* Ensure it appears above other content */
    color: #df6d03
}
.lds-roller div {
  animation: lds-roller 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
  transform-origin: 40px 40px;
}
.lds-roller div:after {
  content: " ";
  display: block;
  position: absolute;
  width: 7.2px;
  height: 7.2px;
  border-radius: 50%;
  background: currentColor;
  margin: -3.6px 0 0 -3.6px;
}
.lds-roller div:nth-child(1) {
  animation-delay: -0.036s;
}
.lds-roller div:nth-child(1):after {
  top: 62.62742px;
  left: 62.62742px;
}
.lds-roller div:nth-child(2) {
  animation-delay: -0.072s;
}
.lds-roller div:nth-child(2):after {
  top: 67.71281px;
  left: 56px;
}
.lds-roller div:nth-child(3) {
  animation-delay: -0.108s;
}
.lds-roller div:nth-child(3):after {
  top: 70.90963px;
  left: 48.28221px;
}
.lds-roller div:nth-child(4) {
  animation-delay: -0.144s;
}
.lds-roller div:nth-child(4):after {
  top: 72px;
  left: 40px;
}
.lds-roller div:nth-child(5) {
  animation-delay: -0.18s;
}
.lds-roller div:nth-child(5):after {
  top: 70.90963px;
  left: 31.71779px;
}
.lds-roller div:nth-child(6) {
  animation-delay: -0.216s;
}
.lds-roller div:nth-child(6):after {
  top: 67.71281px;
  left: 24px;
}
.lds-roller div:nth-child(7) {
  animation-delay: -0.252s;
}
.lds-roller div:nth-child(7):after {
  top: 62.62742px;
  left: 17.37258px;
}
.lds-roller div:nth-child(8) {
  animation-delay: -0.288s;
}
.lds-roller div:nth-child(8):after {
  top: 56px;
  left: 12.28719px;
}
@keyframes lds-roller {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}


</style>

    </head>

    <body>
        <!-- Top Header Start -->
        <div class="top-header">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <div class="logo">
                            <a href="">
                                <img src="img/logo.png" alt="Logo">
                            </a>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="search">
                            <input type="text" placeholder="Search">
                            <button><i class="fa fa-search"></i></button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="user">
                            <div class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">My Account</a>
                                <div class="dropdown-menu">
                                    <a href="#" class="dropdown-item">Login</a>
                                    <a href="#" class="dropdown-item">Register</a>
                                </div>
                            </div>
                            <div class="cart">
                                <i class="fa fa-cart-plus"></i>
                                <span>(0)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Top Header End -->
        
        
        <!-- Header Start -->
        <div class="header">
            <div class="container">
                <nav class="navbar navbar-expand-md bg-dark navbar-dark">
                    <a href="#" class="navbar-brand">MENU</a>
                    <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbarCollapse">
                        <span class="navbar-toggler-icon"></span>
                    </button>

                    <div class="collapse navbar-collapse justify-content-between" id="navbarCollapse">
                        <div class="navbar-nav m-auto">
                            <a href="/" class="nav-item nav-link active">Home</a>
                            <a href="product-list.html" class="nav-item nav-link">Products</a>
                            <div class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Pages</a>
                                <div class="dropdown-menu">
                                    <a href="product-list.html" class="dropdown-item">Product</a>
                                    <a href="product-detail.html" class="dropdown-item">Product Detail</a>
                                    <a href="cart.html" class="dropdown-item">Cart</a>
                                    <a href="wishlist.html" class="dropdown-item">Wishlist</a>
                                    <a href="checkout.html" class="dropdown-item">Checkout</a>
                                    <a href="login.html" class="dropdown-item">Login & Register</a>
                                    <a href="my-account.html" class="dropdown-item">My Account</a>
                                </div>
                            </div>
                            <a href="contact.html" class="nav-item nav-link">Contact Us</a>
                        </div>
                    </div>
                </nav>
            </div>
        </div>
        <!-- Header End -->
        
       

        
        
             <!-- Breadcrumbs Start -->
    <%- include('partials/breadcrumb', { breadcrumbs: breadcrumbs }) %>
    <!-- Breadcrumbs End -->
    <% if (typeof message !== 'undefined' && message) { %>
        <div class="alert alert-success" style="text-align: center;">
            <%= message %>
        </div>
    <% } %>
        
        
<!-- Checkout Start -->
<div id="paypal-error-message" style="display: none; color: red;"></div>

<div class="checkout">
    <div class="container">
        <div class="row">
            <!-- Left Side: Address Selection -->
            <div class="col-md-7">
                <div class="billing-address">
                    <h4 style="font-weight: 600;">Select Address</h4>
                    <form id="address-form" action="/createNewOrder" method="POST">
                        <input type="hidden" name="couponCode" value="<%=couponCode %>">
                        <!-- Address Selection -->
                        <% user.addresses.forEach((address, index) => { %>
                        <div class="custom-control custom-radio">
                            <input type="radio" class="custom-control-input" id="address-<%= index %>" name="shippingInfo" value='<%= JSON.stringify(address) %>' required>
                            <label class="custom-control-label" for="address-<%= index %>">
                                <strong><%= address.label %></strong><br>
                                <%= address.addressLine1 %>, <%= address.addressLine2 %>, <%= address.city %>, <%= address.state %>, <%= address.country %> - <%= address.postalCode %>
                            </label>
                        </div>
                        <% }) %>
                        <div class="custom-control custom-radio">
                            <input type="radio" class="custom-control-input" id="new-address" name="shippingInfo" value="new">
                            <label class="custom-control-label" for="new-address" style="font-weight: 700;">Add New Address</label>
                        </div>

                        <!-- New Address Fields -->
                        <div id="new-address-fields" style="display: none; margin-top: 15px;">
                            <div class="form-group">
                                <select class="form-control" name="newAddress[label]">
                                    <option value="Home">Home</option>
                                    <option value="Work">Work</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <input type="text" class="form-control" name="newAddress[addressLine1]" placeholder="Address Line 1">
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-control" name="newAddress[addressLine2]" placeholder="Address Line 2">
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-control" name="newAddress[city]" placeholder="City">
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-control" name="newAddress[state]" placeholder="State">
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-control" name="newAddress[country]" placeholder="Country">
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-control" name="newAddress[postalCode]" placeholder="Postal Code">
                            </div>
                            <div class="form-group">
                                <input type="number" class="form-control" name="newAddress[phoneNo]" placeholder="Phone Number">
                            </div>
                            
                        </div>

                        <!-- Order Items and Pricing -->
                        <% cart.items.forEach(item => { %>
                            <input type="hidden" name="orderItems[]" value='<%= JSON.stringify({
                              product: item.product._id,
                              quantity: item.quantity,
                              price: item.price,
                              name: item.product.name,
                              image:item.product.images[0]
                            }) %>'>
                        <% }) %>
                          
                        <input type="hidden" name="itemsPrice" value="<%= cart.totalPrice.toFixed(2) %>">
                        <input type="hidden" name="taxPrice" value="0"> <!-- Modify as needed -->
                        <input type="hidden" name="shippingPrice" value="<%= shippingCost %>">
                        <input type="hidden" name="couponDiscount" value="<%= couponDiscount %>">
                        <input type="hidden" name="totalPrice" value="<%= (cart.totalPrice + shippingCost-couponDiscount).toFixed(2) %>">

                       <!-- Payment Methods -->
                       <div class="checkout-payment">
                        <h4 style="font-weight: 600;">Payment Methods</h4>
                        <div class="payment-methods">
                            <% paymentMethods.forEach((method, index) => { %>
                            <div class="custom-control custom-radio">
                                <input type="radio" class="custom-control-input" id="paymentMethod-<%= index %>" name="paymentInfo" value="<%= method %>" required>
                                <label class="custom-control-label" for="paymentMethod-<%= index %>">
                                    <%= method %>
                                </label>
                            </div>
                            <% }) %>
                        </div>
                        
                        <!-- PayPal Button Container (conditionally rendered) -->
                        <div id="paypal-button-container" style="display: none; margin-top: 20px;"></div>
                    
                        <div class="checkout-summary">
                            <p>Shipping Cost: <%= shippingCost %> INR</p>
                            <p>Coupon Discount: <%= couponDiscount %> INR</p>
                            <!-- You can add more summary details here -->
                        </div>
                         <!-- Spinner start -->
       <div id="loading-spinner" class="lds-roller""><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
         <!-- Spinner end -->
                    
                        <div class="checkout-btn">
                            <button type="submit" style="color: rgb(254, 255, 255); background-color: #3F69AA;">Place Order</button>
                        </div>
</div>
                    </form>
                </div>
            </div>

            <!-- Right Side: Checkout Summary -->
            <div class="col-md-5">
                <div class="checkout-summary">
                    <h3 style="font-weight: 600;">Cart Total</h3>
                    <div class="checkout-content">
                        <h3>Products</h3>
                        <% cart.items.forEach(item => { %>
                        <p><%= item.product.name %><span>Rs <%= item.total.toFixed(2) %></span></p>
                        <% }) %>
                        <p class="sub-total">Sub Total<span>Rs <%= cart.totalPrice.toFixed(2) %></span></p>
                        <p class="ship-cost">Shipping Cost<span>
                            <% if (shippingCost === 0) { %>Free<% } else { %>Rs <%= shippingCost.toFixed(2) %><% } %>
                        </span></p>

                         <p class="ship-cost">Coupon Discount <span>
                           <%= couponDiscount.toFixed(2) %>
                        </span></p>
                        <h4 style="color: rgb(130, 245, 130);">Grand Total<span>Rs <%= (cart.totalPrice + shippingCost-couponDiscount).toFixed(2) %></span></h4>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Checkout End -->

<script>
    // JavaScript to toggle the display of new address fields
    document.querySelectorAll('input[name="shippingInfo"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'new') {
                document.getElementById('new-address-fields').style.display = 'block';
            } else {
                document.getElementById('new-address-fields').style.display = 'none';
            }
        });
    });
</script>


        
        
        
        <!-- Footer Start -->
        <div class="footer">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-lg-3 col-md-6">
                        <div class="footer-widget">
                            <h1>E Shop</h1>
                            <p>
                                Lorem ipsum dolor sit amet, consectetur adipiscing elit. Suspendisse sollicitudin rutrum massa. Suspendisse sollicitudin rutrum massa. Vestibulum porttitor, metus sed pretium elementum, nisi nibh sodales quam, non lobortis neque felis id mauris.
                            </p>
                        </div>
                    </div>

                    <div class="col-lg-3 col-md-6">
                        <div class="footer-widget">
                            <h3 class="title">Useful Pages</h3>
                            <ul>
                                <li><a href="product.html">Product</a></li>
                                <li><a href="product-detail.html">Product Detail</a></li>
                                <li><a href="cart.html">Cart</a></li>
                                <li><a href="checkout.html">Checkout</a></li>
                                <li><a href="login.html">Login & Register</a></li>
                                <li><a href="my-account.html">My Account</a></li>
                            </ul>
                        </div>
                    </div>

                    <div class="col-lg-3 col-md-6">
                        <div class="footer-widget">
                            <h3 class="title">Quick Links</h3>
                            <ul>
                                <li><a href="product.html">Product</a></li>
                                <li><a href="cart.html">Cart</a></li>
                                <li><a href="checkout.html">Checkout</a></li>
                                <li><a href="login.html">Login & Register</a></li>
                                <li><a href="my-account.html">My Account</a></li>
                                <li><a href="wishlist.html">Wishlist</a></li>
                            </ul>
                        </div>
                    </div>

                    <div class="col-lg-3 col-md-6">
                        <div class="footer-widget">
                            <h3 class="title">Get in Touch</h3>
                            <div class="contact-info">
                                <p><i class="fa fa-map-marker"></i>123 E Shop, Los Angeles, CA, USA</p>
                                <p><i class="fa fa-envelope"></i>email@example.com</p>
                                <p><i class="fa fa-phone"></i>+123-456-7890</p>
                                <div class="social">
                                    <a href=""><i class="fa fa-twitter"></i></a>
                                    <a href=""><i class="fa fa-facebook"></i></a>
                                    <a href=""><i class="fa fa-linkedin"></i></a>
                                    <a href=""><i class="fa fa-instagram"></i></a>
                                    <a href=""><i class="fa fa-youtube"></i></a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row payment">
                    <div class="col-md-6">
                        <div class="payment-method">
                            <p>We Accept:</p>
                            <img src="img/payment-method.png" alt="Payment Method" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="payment-security">
                            <p>Secured By:</p>
                            <img src="img/godaddy.svg" alt="Payment Security" />
                            <img src="img/norton.svg" alt="Payment Security" />
                            <img src="img/ssl.svg" alt="Payment Security" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Footer End -->

        
        <!-- Footer Bottom Start -->
        <div class="footer-bottom">
            <div class="container">
                <div class="row">
                    <div class="col-md-6 copyright">
                        <p>Copyright &copy; <a href="https://htmlcodex.com">HTML Codex</a>. All Rights Reserved</p>
                    </div>

                    <div class="col-md-6 template-by">
                        <p>Template By <a href="https://htmlcodex.com">HTML Codex</a></p>
                    </div>
                </div>
            </div>
        </div>
        <!-- Footer Bottom End -->
        
        
        <!-- Back to Top -->
        <a href="#" class="back-to-top"><i class="fa fa-chevron-up"></i></a>

        
        <!-- JavaScript Libraries -->
        <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
        <script src="lib/easing/easing.min.js"></script>
        <script src="lib/slick/slick.min.js"></script>

        
        <!-- Template Javascript -->
        <script src="js/main.js"></script>
        <!-- <script>
        document.addEventListener("DOMContentLoaded", function () {
            const newAddressRadio = document.getElementById('new-address');
            const newAddressFields = document.getElementById('new-address-fields');
        
            newAddressRadio.addEventListener('change', function () {
                if (this.checked) {
                    newAddressFields.style.display = 'block';
                }
            });
        
            const existingAddressRadios = document.querySelectorAll('input[name="shippingInfo"]:not(#new-address)');
            existingAddressRadios.forEach(radio => {
                radio.addEventListener('change', function () {
                    if (this.checked) {
                        newAddressFields.style.display = 'none';
                    }
                });
            });
        });
    </script> -->
    <script>
        async function getUSDValue(amountInINR) {
            try {
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/INR');
                const data = await response.json();
                const conversionRate = data.rates.USD;
                return (amountInINR * conversionRate).toFixed(2);
            } catch (error) {
                console.error('Error fetching exchange rate:', error);
                return null;
            }
        }
    
        document.addEventListener('DOMContentLoaded', async function() {
            const form = document.getElementById('address-form');
            let isPayPalSelected = false;
    
            // Assuming `totalAmountInINR` is a numeric value after server-side rendering
            const totalAmountInINR = parseFloat('<%= cart.totalPrice + shippingCost - couponDiscount %>');
            const amountInUSD = await getUSDValue(totalAmountInINR);
    
            document.querySelectorAll('input[name="paymentInfo"]').forEach((radio) => {
                radio.addEventListener('change', function() {
                    if (this.value === 'PayPal') {
                        isPayPalSelected = true;
                        document.getElementById('paypal-button-container').style.display = 'block';
    
                        // Initialize PayPal Buttons only once
                        if (!document.getElementById('paypal-button-container').hasChildNodes()) {
                            paypal.Buttons({
                                createOrder: function(data, actions) {
                                     // Show loading spinner when order creation starts
                                      showLoadingSpinner();
                                      
                                    return actions.order.create({
                                        purchase_units: [{
                                            amount: {
                                                currency_code: 'USD',
                                                value: amountInUSD // Use dynamically converted USD value
                                            }
                                        }]
                                    });
                                },
                                onApprove: function(data, actions) {
                                    return actions.order.capture().then(function(details) {
                                        alert('Transaction completed by ' + details.payer.name.given_name);
    
                                        // Clear any existing hidden paymentInfo fields
                                        form.querySelectorAll('input[name^="paymentInfo"]').forEach(input => input.remove());
    
                                        // Add PayPal payment details to the form as hidden fields
                                        const paymentMethodInput = document.createElement('input');
                                        paymentMethodInput.type = 'hidden';
                                        paymentMethodInput.name = 'paymentInfo[method]';
                                        paymentMethodInput.value = 'PayPal';
                                        form.appendChild(paymentMethodInput);
    
                                        const paymentStatusInput = document.createElement('input');
                                        paymentStatusInput.type = 'hidden';
                                        paymentStatusInput.name = 'paymentInfo[status]';
                                        paymentStatusInput.value = details.status;
                                        form.appendChild(paymentStatusInput);
    
                                        const paymentIdInput = document.createElement('input');
                                        paymentIdInput.type = 'hidden';
                                        paymentIdInput.name = 'paymentInfo[id]';
                                        paymentIdInput.value = details.id || data.orderID;
                                        form.appendChild(paymentIdInput);
    
                                        // Submit the form programmatically after payment is approved
                                        form.submit();
                                    });
                                },
                                onError: function(err) {
                                    console.error('Error during transaction:', err);
                                    // Display error message to the user
                                    document.getElementById('paypal-error-message').innerText = 'An error occurred with the payment. Please check your PayPal balance or payment method and try again.';
                                    document.getElementById('paypal-error-message').style.display = 'block';
                                }
                            }).render('#paypal-button-container');
                        }
                    } else {
                        isPayPalSelected = false;
                        document.getElementById('paypal-button-container').style.display = 'none';
                    }
                });
            });
    
            // Prevent form submission until PayPal payment is processed
            form.addEventListener('submit', function(event) {
                if (isPayPalSelected) {
                    event.preventDefault();
                    // The form will be submitted programmatically after PayPal payment is approved
                }
            });
    
            document.getElementById('new-address').addEventListener('change', function() {
                document.getElementById('new-address-fields').style.display = 'block';
            });
            document.querySelectorAll('input[name="shippingInfo"]').forEach((radio) => {
                radio.addEventListener('change', function() {
                    if (this.id !== 'new-address') {
                        document.getElementById('new-address-fields').style.display = 'none';
                    }
                });
            });
        });
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        document.getElementById('address-form').addEventListener('submit', function(event) {
    showLoadingSpinner(); // Show the loading spinner
});

function showLoadingSpinner() {
    document.getElementById('loading-spinner').style.display = 'block';
}

    </script>
    
    
    
    
    
     
    
    
    
            
            
    </body>
</html>
