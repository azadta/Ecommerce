<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>E Shop - Bootstrap Ecommerce Template</title>
        <meta content="width=device-width, initial-scale=1.0" name="viewport">
        <meta content="Bootstrap Ecommerce Template" name="keywords">
        <meta content="Bootstrap Ecommerce Template Free Download" name="description">

        <!-- Favicon -->
        <link href="/img/favicon.ico" rel="icon">

        <!-- Google Fonts -->
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,700&display=swap" rel="stylesheet">

        <!-- CSS Libraries -->
        <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
        <link href="/lib/slick/slick.css" rel="stylesheet">
        <link href="/package.json" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">


        <!-- Template Stylesheet -->
        <link href="/css/style.css" rel="stylesheet">
        <style>
                  .cart i {
    font-size: 24px; /* Adjust the size as needed */
      }

    .cart span {
    font-size: 18px; /* Adjust the size of the item count as needed */
    margin-left: 5px; /* Add some spacing between the icon and the count */
    font-weight: bold; /* Make the item count bold */
}
.cart-header {
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f4f4f4;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
    margin-top: -20px; /* Adjust this value as needed to move the element up */
}

.cart-icon {
    font-size: 35px;
    color: #16a085;
    margin-right: 15px;
    margin-bottom: 10px;
}

.cart-header h1 {
    font-size: 36px;
    color: #333;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
}
#message-box {
  position: absolute; /* Change to absolute to move with page content */
  top: 200px;
  left: 50%;
  transform: translateX(-50%);
  background-color: #4CAF50; /* Green */
  color: white;
  padding: 15px;
  font-size: 16px;
  border-radius: 5px;
  z-index: 1000;
  display: none;
}





        </style>
    </head>

    <body>
        <!-- Top Header Start -->
        <div class="top-header">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <div class="logo">
                            <a href="">
                                <img src="/img/logo.png" alt="Logo">
                            </a>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="search">
                            <input type="text" placeholder="Search">
                            <button><i class="fa fa-search"></i></button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="user">
                            <div class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">My Account</a>
                                <div class="dropdown-menu">
                                    <a href="#" class="dropdown-item">Login</a>
                                    <a href="#" class="dropdown-item">Register</a>
                                </div>
                            </div>
                            <div class="cart">
                                <a href="/myCart">
                                    <i class="fa fa-cart-plus"></i>
                                    <span>(<%= cart.totalQuantity %>)</span>
                                </a>
                            </div>
                        </div>
                        
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Top Header End -->
        
        
        <!-- Header Start -->
        <div class="header">
            <div class="container">
                <nav class="navbar navbar-expand-md bg-dark navbar-dark">
                    <a href="#" class="navbar-brand">MENU</a>
                    <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbarCollapse">
                        <span class="navbar-toggler-icon"></span>
                    </button>

                    <div class="collapse navbar-collapse justify-content-between" id="navbarCollapse">
                        <div class="navbar-nav m-auto">
                            <a href="/" class="nav-item nav-link active">Home</a>
                            <a href="product-list.html" class="nav-item nav-link">Products</a>
                            <div class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Pages</a>
                                <div class="dropdown-menu">
                                    <a href="product-list.html" class="dropdown-item">Product</a>
                                    <a href="product-detail.html" class="dropdown-item">Product Detail</a>
                                    <a href="cart.html" class="dropdown-item">Cart</a>
                                    <a href="wishlist.html" class="dropdown-item">Wishlist</a>
                                    <a href="checkout.html" class="dropdown-item">Checkout</a>
                                    <a href="login.html" class="dropdown-item">Login & Register</a>
                                    <a href="my-account.html" class="dropdown-item">My Account</a>
                                </div>
                            </div>
                            <a href="contact.html" class="nav-item nav-link">Contact Us</a>
                        </div>
                    </div>
                </nav>
            </div>
        </div>
        <!-- Header End -->
        
        
        
        
           
           <!-- Breadcrumbs Start -->
           <%if(typeof breadcrumbs!=='undefined' && breadcrumbs) { %> 
            <%- include('partials/breadcrumb', { breadcrumbs: breadcrumbs }) %>
            <% } %>

            <div class="cart-header">
                <i class="fa fa-shopping-cart cart-icon"></i>
                <h2>My Cart</h2>
              </div>
              
              <div id="message-box" class="alert alert-success" style="display: none; text-align: center;"></div>
              <% if (typeof message!=='undefined'&& message) { %>

                <h4 style="color: rgb(17, 193, 29); text-align: center;"><%= message %></h4>
            <% } %>
              
              <!-- Cart Start -->
              <div class="cart-page">
                <div class="container">
                  <div class="row">
                    <div class="col-md-12">
                      <div class="table-responsive">
                        <table class="table table-bordered">
                          <thead class="thead-dark">
                            <tr>
                              <th>Image</th>
                              <th>Name</th>
                              <th>Price</th>
                              <th>Quantity</th>
                              <th>Total</th>
                              <th>Remove</th>
                            </tr>
                          </thead>
                          <tbody class="align-middle">
                            <% if (items && items.length > 0) { %>
                              <% items.forEach(item => { %>
                                <tr>
                                  <td><img src="/uploads/<%= item.product.images[0] %>" alt="Image" width="70" height="70"></td>
                                  <td><%= item.product.name %></td>
                                  <td>Rs <%= item.price %></td>
                                  <td>
                                    <button class="quantity-arrow" data-product-id="<%= item.product._id %>" data-change="-1">-</button>
                                    <input type="text" class="quantity-input" value="<%= item.quantity %>" disabled style="width: 60px;">
                                    <button class="quantity-arrow" data-product-id="<%= item.product._id %>" data-change="1">+</button>
                                  </td>
                                  <td class="total-cell">Rs <%= item.total %></td>
                                  <td>
                                    <form action="/deleteProductFromCart/<%= item.product._id %>?_method=delete" method="POST">
                                      <button type="submit" class="btn btn-danger btn-sm"><i class="fa fa-trash"></i></button>
                                    </form>
                                  </td>
                                </tr>
                              <% }) %>
                            <% } else { %>
                              <tr>
                                <td colspan="6" class="text-center">Your cart is empty</td>
                              </tr>
                            <% } %>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="cart-summary">
                        <div class="cart-content">
                          <h3>Cart Summary</h3>
                          <p>Sub Total<span id="cart-total">Rs <%= cart.totalPrice.toFixed(2) %></span></p>
                     
                          <% let shippingCost = cart.totalPrice > 1000 ? 0 : cart.totalQuantity * 50; %>

<!-- Display Shipping Cost -->
<p>Shipping Cost: 
    <span id="shipping-cost">
        <% if (cart.totalPrice > 1000) { %>
            <span style="color: rgb(167, 242, 92);">Free</span>
            <span style="text-decoration: line-through; margin-right: 8px;">Rs <%= cart.totalQuantity * 50 %></span>
        <% } else { %>
            Rs <%= cart.totalQuantity * 50 %>
        <% } %>
    </span>
</p>

<!-- Amount Saved by Applying Coupon -->
<% if (typeof couponDiscount !== 'undefined' && couponDiscount) { %>
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 style="color: rgb(138, 234, 159);">Amount Saved by Applying Coupon:</h5>
        <h5 style="color: rgb(138, 234, 159);" id="coupon-discount">Rs <%= couponDiscount %></h5>
    </div>
<% } %>

  <% if(typeof couponDiscount!=='undefined'&&couponDiscount){ %>                        
<h4 style="font-weight: 700;">Grand Total: 
    <span class="new-total">Rs 
        <%= (parseFloat(cart.totalPrice) + parseFloat(shippingCost)-parseFloat(couponDiscount) ).toFixed(2)%>
    </span>
</h4>
    <% }else{ %>
        <h4 style="font-weight: 700;">Grand Total: 
            <span class="new-total">Rs 
                <%= (parseFloat(cart.totalPrice) + parseFloat(shippingCost) ).toFixed(2)%>
            </span>
        </h4>
        <% } %>



                          


    </div>
  




                            <div class="cart-btn">
                                <% if(typeof couponDiscount!=='undefined'&&couponDiscount){ %>
                             
                                <form action="/checkout" method="post">
                                   
                                    <input type="hidden" name="shippingCost" value="<%= shippingCost %>">
                                    <input type="hidden" name="couponDiscount" value="<%= couponDiscount %>">
                                    <input type="hidden" name="couponCode" value="<%= couponCode %>">
                              
                                <button type="submit" style="color: rgb(254, 255, 255); background-color: #3F69AA;">Checkout</button>
                            </form>
                            <% }else{ %>
                                <form action="/checkout" method="post">
                                 
                                    <input type="hidden" name="shippingCost" value="<%= shippingCost %>">
                                  
                              
                                <button type="submit" style="color: rgb(254, 255, 255); background-color: #3F69AA;">Checkout</button>
                            </form>
                            <% } %>





                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="coupon">
                            <!-- Form to apply the coupon -->
                            <form action="/applyCoupon" method="POST">
                                <label for="couponCode" style="font-weight: 600;">Select Coupon Code:</label>
                                <select name="couponCode" id="couponCode" required >
                                    <option value="" >--Select Coupon--</option>
                                    <% if (typeof coupons !== 'undefined' && coupons) { %>
                                        <% coupons.forEach(coupon => { %>
                                            <option value="<%= coupon.code %>" <%= coupon.code === selectedCouponCode ? 'selected' : '' %>>
                                                <%= coupon.code %> - <%= coupon.discountPercentage %> % off
                                            </option>
                                        <% }) %>
                                    <% } %>
                                </select>
                                <input type="hidden" name="orderTotal" value="<%= cart.totalPrice %>">
                                <input type="hidden" name="productCategories" value='<%= JSON.stringify(cart.items.map(item => item.product.categoryId)) %>'>
                                <button type="submit" class="btn-sm">Apply Code</button>
                            </form>
                            
                            <br>
                            <br>
                            <% if((typeof couponCode!=='undefined'&&couponCode)&&(typeof orderTotal!=='undefined'&&orderTotal)){ %>
                            <form action="/cancelCoupon" method="POST">
                                <!-- Hidden input to send the coupon code -->
                                <input id="coupon-code" type="hidden" name="couponCode" value="<%= couponCode %>">
                            
                                <!-- Hidden input to send the order total -->
                                <input type="hidden" name="orderTotal" value="<%= orderTotal %>">
                            
                                <!-- Cancel Coupon Button -->
                                <button type="submit" class="btn-sm btn-danger" style="background-color: rgb(241, 85, 53)">RemoveCoupon</button>
                            </form>
                            <% } %>
                            
                        </div>
                        <br><br>
                    
                     
                        
                    </div>
                    
                    
                </div>
            </div>
            <br>
            <br>
            <!-- Pagination -->
            <nav aria-label="Page navigation example">
                <ul class="pagination justify-content-center">
                    <% if (currentPage > 1) { %>
                        <li class="page-item">
                            <a class="page-link" href="/myCart?page=<%= currentPage - 1 %>&limit=<%= itemsPerPage %>">Previous</a>
                        </li>
                    <% } else { %>
                        <li class="page-item disabled">
                            <a class="page-link" href="#">Previous</a>
                        </li>
                    <% } %>
                    <% for (let i = 1; i <= totalPages; i++) { %>
                        <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                            <a class="page-link" href="/myCart?page=<%= i %>&limit=<%= itemsPerPage %>"><%= i %></a>
                        </li>
                    <% } %>
                    <% if (currentPage < totalPages) { %>
                        <li class="page-item">
                            <a class="page-link" href="/myCart?page=<%= currentPage + 1 %>&limit=<%= itemsPerPage %>">Next</a>
                        </li>
                    <% } else { %>
                        <li class="page-item disabled">
                            <a class="page-link" href="#">Next</a>
                        </li>
                    <% } %>
                </ul>
            </nav>
        </div>
        <!-- Cart End -->


        
        
        <!-- Footer Start -->
        <div class="footer">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-lg-3 col-md-6">
                        <div class="footer-widget">
                            <h1>E Shop</h1>
                            <p>
                                Lorem ipsum dolor sit amet, consectetur adipiscing elit. Suspendisse sollicitudin rutrum massa. Suspendisse sollicitudin rutrum massa. Vestibulum porttitor, metus sed pretium elementum, nisi nibh sodales quam, non lobortis neque felis id mauris.
                            </p>
                        </div>
                    </div>

                    <div class="col-lg-3 col-md-6">
                        <div class="footer-widget">
                            <h3 class="title">Useful Pages</h3>
                            <ul>
                                <li><a href="product.html">Product</a></li>
                                <li><a href="product-detail.html">Product Detail</a></li>
                                <li><a href="cart.html">Cart</a></li>
                                <li><a href="checkout.html">Checkout</a></li>
                                <li><a href="login.html">Login & Register</a></li>
                                <li><a href="my-account.html">My Account</a></li>
                            </ul>
                        </div>
                    </div>

                    <div class="col-lg-3 col-md-6">
                        <div class="footer-widget">
                            <h3 class="title">Quick Links</h3>
                            <ul>
                                <li><a href="product.html">Product</a></li>
                                <li><a href="cart.html">Cart</a></li>
                                <li><a href="checkout.html">Checkout</a></li>
                                <li><a href="login.html">Login & Register</a></li>
                                <li><a href="my-account.html">My Account</a></li>
                                <li><a href="wishlist.html">Wishlist</a></li>
                            </ul>
                        </div>
                    </div>

                    <div class="col-lg-3 col-md-6">
                        <div class="footer-widget">
                            <h3 class="title">Get in Touch</h3>
                            <div class="contact-info">
                                <p><i class="fa fa-map-marker"></i>123 E Shop, Los Angeles, CA, USA</p>
                                <p><i class="fa fa-envelope"></i>email@example.com</p>
                                <p><i class="fa fa-phone"></i>+123-456-7890</p>
                                <div class="social">
                                    <a href=""><i class="fa fa-twitter"></i></a>
                                    <a href=""><i class="fa fa-facebook"></i></a>
                                    <a href=""><i class="fa fa-linkedin"></i></a>
                                    <a href=""><i class="fa fa-instagram"></i></a>
                                    <a href=""><i class="fa fa-youtube"></i></a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row payment">
                    <div class="col-md-6">
                        <div class="payment-method">
                            <p>We Accept:</p>
                            <img src="/img/payment-method.png" alt="Payment Method" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="payment-security">
                            <p>Secured By:</p>
                            <img src="/img/godaddy.svg" alt="Payment Security" />
                            <img src="/img/norton.svg" alt="Payment Security" />
                            <img src="/img/ssl.svg" alt="Payment Security" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Footer End -->

        
        <!-- Footer Bottom Start -->
        <div class="footer-bottom">
            <div class="container">
                <div class="row">
                    <div class="col-md-6 copyright">
                        <p>Copyright &copy; <a href="https://htmlcodex.com">HTML Codex</a>. All Rights Reserved</p>
                    </div>

                    <div class="col-md-6 template-by">
                        <p>Template By <a href="https://htmlcodex.com">HTML Codex</a></p>
                    </div>
                </div>
            </div>
        </div>
        <!-- Footer Bottom End -->
        
        
        <!-- Back to Top -->
        <a href="#" class="back-to-top"><i class="fa fa-chevron-up"></i></a>

        
        <!-- JavaScript Libraries -->
        <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
        <script src="lib/easing/easing.min.js"></script>
        <script src="lib/slick/slick.min.js"></script>

        
        <!-- Template Javascript -->
        <script src="/js/main.js"></script>
        <script>
            $(document).ready(function() {
                $('.quantity-arrow').click(function() {
                    const $this = $(this);
                    const productId = $this.data('product-id');
                    const quantityChange = $this.data('change');
                    const $quantityInput = $this.closest('tr').find('.quantity-input');
                    const $totalCell = $this.closest('tr').find('.total-cell');
                    const $cartTotal = $('#cart-total');
                    const $cartQuantity = $('#cart-quantity');
                    const $couponDiscount = $('#coupon-discount');
                    const $newTotal = $('.new-total');
                    const $messageBox = $('#message-box'); // Select the message box element
            
                    // Get the couponCode if it exists
                    const couponCode = $('#coupon-code').val() || ''; // Assuming there's an input field with id 'coupon-code'
                    
                    // Construct the URL with the couponCode as a query parameter
                    let url = `/updateCart/${productId}`;
                    if (couponCode) {
                        url += `?couponCode=${encodeURIComponent(couponCode)}`;
                    }
            
                    $.ajax({
                        url: url,
                        method: 'PUT',
                        contentType: 'application/json', // Specify content type for the request body
                        data: JSON.stringify({ quantityChange }), // Send quantityChange in request body
                        success: function(response) {
    $quantityInput.val(response.updatedItem.quantity);
    $totalCell.text('Rs ' + response.updatedItem.total.toFixed(2));
    $cartTotal.text('Rs ' + response.newTotal.toFixed(2)); 
    $cartQuantity.text(response.totalQuantity);

    // Calculate and update the Grand Total
    const couponDiscount = parseFloat(response.couponDiscount || 0);
    const newTotal = parseFloat(response.newTotal || 0);

    // Calculate shipping cost dynamically
    const shippingCost = parseFloat(response.newTotal) > 1000 ? 0 : parseFloat(response.totalQuantity) * 50;

    // Update shipping cost in the DOM
    const $shippingCost = $('#shipping-cost');
    if (shippingCost === 0) {
        $shippingCost.html('<span style="color: rgb(167, 242, 92);">Free</span>' +
            '<span style="text-decoration: line-through; margin-right: 8px;">Rs ' + (response.totalQuantity * 50) + '</span>');
    } else {
        $shippingCost.text('Rs ' + shippingCost.toFixed(2));
    }

    const grandTotal = (newTotal - couponDiscount + shippingCost).toFixed(2);

    $couponDiscount.text('Rs ' + couponDiscount);
    $newTotal.text('Rs ' + grandTotal);

    // Show success message
    $messageBox.stop(true, true).hide().css('background-color', 'green').text(response.successMessage).fadeIn().delay(5000).fadeOut();
},

                        error: function(xhr) {
                            // Show error message with a red background
                            const errorMessage = xhr.responseJSON.message;
                            $messageBox.stop(true, true).hide().css('background-color', 'red').text(errorMessage).fadeIn().delay(5000).fadeOut();
                        }
                    });
                });
            });
            </script>
            
            
            
            
            
          
    </body>
</html>
